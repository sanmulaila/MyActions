name: Update Script File


on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'


env:
  TZ: Asia/Shanghai

  
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ["12"]
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.

      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Create local changes
        run: |
          wget_options='-q -c -N --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=20 -t 3 --no-check-certificate -O'
          user_agent='Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36'
          aria2c_options='--split=8 --quiet=true --max-connection-per-server=8 --retry-wait=20 --timeout=20 --check-certificate=false --allow-overwrite=true -U "${user_agent}"'
          sudo apt-get install -y aria2
          yarn global add pangu

          if [ ! -d config ];then
                  mkdir config
          fi              
          cd config/
          aria2c ${aria2c_options} -o 'config.sample.sh' 'https://raw.githubusercontent.com/Oreomeow/VIP/main/Conf/Qinglong/config.sample.sh'
          aria2c ${aria2c_options} -o 'code.sample.sh' 'https://raw.githubusercontent.com/Oreomeow/VIP/main/Scripts/sh/Helpcode2.8/code.sh'
          aria2c ${aria2c_options} -o 'config.template.json' 'https://gitee.com/sitoi/dailycheckin/raw/main/docker/config.template.json'
          pangu -f code.sample.sh >> code.sample_1.sh
          pangu -f config.sample.sh >> config.sample_1.sh
          pangu -f config.template.json >> config.template_1.json
          ls *.* |awk -F "_1" '{print "mv -f "$0" "$1$2""}'|bash

          cd ../checkin/
          aria2c ${aria2c_options} -o 'netease.py' 'https://raw.githubusercontent.com/Oreomeow/VIP/main/Scripts/py/netease.py'
          aria2c ${aria2c_options} -o 'mimotion.py' 'https://raw.githubusercontent.com/Oreomeow/VIP/main/Scripts/py/mimotion.py'

          cd ../jd_scripts/
          aria2c ${aria2c_options} -o 'gua_wealth_island_help.js' 'https://raw.githubusercontent.com/smiek2221/scripts/master/gua_wealth_island_help.js'
          aria2c ${aria2c_options} -o 'gua_wealth_island.js' 'https://raw.githubusercontent.com/jiulan/platypus/main/scripts/jd_cfd_new.js'
          aria2c ${aria2c_options} -o 'jd_all_bean_change.js' 'https://raw.githubusercontent.com/jiulan/platypus/main/scripts/jd_all_bean_change.js'
          aria2c ${aria2c_options} -o 'jd_bean_change_new.js' 'https://raw.githubusercontent.com/shufflewzc/faker2/main/jd_bean_change_new.js'
          aria2c ${aria2c_options} -o 'jd_bean_change.js' 'https://raw.githubusercontent.com/yuannian1112/jd_scripts/main/jd_bean_change.js'
          aria2c ${aria2c_options} -o 'star_dreamFactory_tuan.js' 'https://raw.githubusercontent.com/Aaron-lv/sync/jd_scripts/jd_ccSign.js'
          aria2c ${aria2c_options} -o 'jd_dreamFactory_tuan.js' 'https://raw.githubusercontent.com/star261/jd/main/scripts/star_dreamFactory_tuan.js'
          aria2c ${aria2c_options} -o 'jd_jxlhb.js' 'https://raw.githubusercontent.com/Aaron-lv/sync/jd_scripts/jd_jxlhb.js'
          aria2c ${aria2c_options} -o 'jd_jxmc.js' 'https://raw.githubusercontent.com/Aaron-lv/sync/jd_scripts/jd_jxmc.js'
          aria2c ${aria2c_options} -o 'jd_redPacket.js' 'https://raw.githubusercontent.com/Aaron-lv/sync/jd_scripts/jd_redPacket.js'
          aria2c ${aria2c_options} -o 'package.json' 'https://raw.githubusercontent.com/shufflewzc/faker2/main/package.json'
          aria2c ${aria2c_options} -o 'USER_AGENTS.js' 'https://raw.githubusercontent.com/yuannian1112/jd_scripts/main/USER_AGENTS.js'
          aria2c ${aria2c_options} -o 'jx_sign.js' 'https://raw.githubusercontent.com/Aaron-lv/sync/jd_scripts/jx_sign.js'
          sed -e 's|"undefined"!=typeof process&&JSON.stringify(process.env).indexOf("GITHUB")>-1&&process.exit(0);||g' -i *.js
          sed -e "/if (JSON.stringify(process.env).indexOf('GITHUB') > -1) process.exit(0);/d" -i jd_redPacket.js
          sed -e 's|const HelpAuthorFlag = true|const HelpAuthorFlag = true|g' -i gua_wealth_island.js
          sed -e 's|let buildLvlUp = true|let buildLvlUp = false|g' -i gua_wealth_island.js

      - name: Commit files
        run: |
          git config --local user.email "78083448+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # git commit -am "Add changes."
          git add .
          git commit -m "Add changes."

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.TOKEN }}
          branch: ${{ github.ref }}
          
      - name: sendMessage
        run: bash checkin/sendMessage.sh updateMsg
